---
title: "Fire_summary"
author: "Derek Corcoran"
date: "November 9, 2015"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=FALSE)
```

#Abstract

This webpage will show the results of a bat survey study done in the Plumas National Forest in North California. The objective of this study is to determine the distribution of the different species of bats within the park. In order to do that we have performed occupancy models for the species present in the park. The results of this models will be shown as maps showing the probability of occurence of bats in each point, that is, if you see a value of 1, there is a 100% chance of finding a bat in that point, if there is a value of 0 there is 0% chance of finding that specie in that point, if there is a value of 0.5 there is a 50% chance of finding that specie in that point.

Another result

```{r, message=FALSE, warning=FALSE, echo=FALSE,results='hide'}
#first load libraries
library(raster)
library(rasterVis)
library(maps)
library(maptools)
library(rgdal)
library(latticeExtra)
library(dplyr)
library(knitr)
library(unmarked)
library(lubridate)
library(jpeg)
library(stargazer)
library(xtable)
library(MuMIn)
library(ggplot2)
library(RCurl)
library(foreign)
```


```{r, message=FALSE, warning=FALSE, echo=FALSE, results='hide', cache=TRUE}
#read rasters
PNF<- readGDAL("~/new_bats/Rnew_bats/Bats_data_products/PNF.asc")
PNF<-raster (PNF)
bc <- readGDAL("~/new_bats/Rnew_bats/Bats_data_products/bc.asc")
bc<-raster (bc)
bb <- readGDAL("~/new_bats/Rnew_bats/Bats_data_products/bb.asc")
bb<-raster (bb)
bs <- readGDAL("~/new_bats/Rnew_bats/Bats_data_products/bs.asc")
bs<-raster (bs)
topo <- readGDAL("~/new_bats/Rnew_bats/Bats_data_products/topo.asc")
topo<-raster (topo)
topo<-topo*PNF
Vegetation_existing <- readGDAL("~/new_bats/Rnew_bats/Bats_data_products/Vegetation_existing.asc")
Vegetation_existing<-raster (Vegetation_existing)
FireReturnAll <- readGDAL("~/new_bats/Rnew_bats/Bats_data_products/FireReturnAll.asc")
FireReturnAll<-raster (FireReturnAll)
```


```{r, echo=FALSE, results='hide', message=FALSE}
#bb<-projectRaster(bb1, PNF)
#bs<-projectRaster(bs1, PNF)
#bc<-projectRaster(bc1, PNF)
#Vegetation_existing<-projectRaster(Vegetation_existing, PNF)
#FireReturnAll<-projectRaster(FireReturnAll, PNF)
```

```{r, echo=FALSE, results='hide', message=FALSE}
#bc<-resample(bc, PNF)
#bb<-resample(bb, PNF)
#bs<-resample(bs, PNF)
#Vegetation_existing<-resample(Vegetation_existing, PNF, method="ngb")
#FireReturnAll<-resample(FireReturnAll, PNF)
#topo<-resample(topo,PNF)
```

```{r, echo=FALSE, results='hide', warning=FALSE, cache=TRUE}
roaddist.r<- readGDAL("~/new_bats/Rnew_bats/Bats_data_products/roaddist.asc")
roaddist.r<-raster (roaddist.r)
roaddist.r<- roaddist.r*PNF
```

```{r,echo=FALSE,warning=FALSE,message=FALSE,results='hide', cache=TRUE}
riverdist.r<- readGDAL("~/new_bats/Rnew_bats/Bats_data_products/riverdist.asc")
riverdist.r<-raster (riverdist.r)
riverdist.r<- riverdist.r*PNF
riverdist.r<- riverdist.r*PNF

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
riverdist.r2 <- riverdist.r^2
roaddist.r2 <- roaddist.r^2
Vegetation_existing2<- Vegetation_existing^2
FireReturnAll2<- FireReturnAll^2
topo2<- topo^2
bs2 <- bs^2
bc2 <- bc^2
bb2 <- bb^2
Predictors <-stack(riverdist.r, riverdist.r2, roaddist.r, roaddist.r2, Vegetation_existing, Vegetation_existing2, FireReturnAll, FireReturnAll2, topo, topo2, bs, bs2,bc, bc2, bb, bb2)
names(Predictors)<-c("Distance to water","Distance to water2" , "Distance to road","Distance to road2", "Existing vegetation","Existing vegetation2","Fire Interval","Fire Interval2", "Altitude", "Altitude2", "Burn intensity soil", "Burn intensity soil2","Burn intensity Canopy", "Burn intensity Canopy2", "Burn intensity basal","Burn intensity basal2")
```

```{r, echo=FALSE}
#then add the data
RESULTS <- read.csv("~/new_bats/Rnew_bats/Bats_data_products/RESULTS.csv")
RESULTS <- RESULTS[,-1]
RESULTS$START.DATE<- dmy(as.character(RESULTS$START.DATE), tz = "America/Los_Angeles")
RESULTS$END.DATE<- dmy(as.character(RESULTS$END.DATE), tz = "America/Los_Angeles")
```


```{r,echo=FALSE, warning=FALSE,message=FALSE}
Dailycov3 <- read.csv("~/new_bats/Rnew_bats/Bats_data_products/Dailycov3.csv")
Dailycov3 <- Dailycov3 [,-1]

Julian<-Dailycov3[,1:3]
Max.hum<-Dailycov3[,4:6]
Max.temp<-Dailycov3[,7:9]
Mean.hum<-Dailycov3[,10:12]
Mean.temp<-Dailycov3[,13:15]
Min.hum<-Dailycov3[,16:18]
Min.temp<-Dailycov3[,19:21]
Sd.hum<-Dailycov3[,22:24]
Sd.temp<-Dailycov3[,25:27]

Dailycov3<- list(Julian,Max.hum, Max.temp, Mean.hum,Mean.temp, Min.hum, Min.temp, Sd.hum, Sd.temp)
names(Dailycov3) <- c("Julian", "Maxhum","Maxtemp","Meanhum", "Meantemp","Minhum","Mintemp","sdhum","sdtemp")
sampling.cov2 <- read.csv("~/new_bats/Rnew_bats/Bats_data_products/sampling.cov2.csv")
sampling.cov2<- sampling.cov2[,-1]
sampling.cov2<- data.frame(sampling.cov2)
sampling.cov2<- mutate(sampling.cov2, Burn.intensity.soil2 = Burn.intensity.soil^2, Burn.intensity.Canopy2 = Burn.intensity.Canopy^2, Burn.intensity.basal2 = Burn.intensity.basal^2)


```

#Results collected in the field 


```{r, echo=FALSE}
plot(Predictors)
```

```{r,echo=FALSE, warning=FALSE,message=FALSE}
Result2<-read.csv("~/new_bats/Rnew_bats/Bats_data_products/RESULTS2.csv")
Result2<- Result2[,-1]
```




#Maps showing the sampled Points

```{r,echo=FALSE, warning=FALSE,message=FALSE}
plot(PNF, legend=FALSE)
points(RESULTS$LONG, RESULTS$LAT, cex=0.5)
map.scale(-120.7, 39.5, relwidth = 0.15, metric = TRUE, ratio = FALSE,cex=0.7)
```

#Results of species prescence

In this area 0 means absence, and 1 means prescence. This table has for each site (ID), every specie and day, so for example if Mylu1=0, that means that for *Myotis lucifugus* (common name Little Brown bat, was detected on day one for that particular site).

##Here is a key for bat species

- *Myotis yumanensis* (Myyu)
- *Myotis californicus* (Myca)
- *Myotis ciliolabrum* (Myci)
- *Myotis volans* (Myvo)
- *Myotis lucifugus* (Mylu)
- *Parastrellus hesperus* (Pahe)
- *Lasiurus blossevillii* (Labo)
- *Myotis evotis* (Myev)
- *Antrozous pallidus*  **(Anpa)**
- *Eptesicus fuscus* (Epfu)
- *Lasionycteris noctivagans* (Lano)
- *Myotis thysanodes* **(Myth)**
- *Tadarida brasiliensis* (Tabr)
- *Lasiurus cinereus* (Laci)
- *Corynorhinus townsendii* **(Coto)**
- *Euderma maculatum* (Euma)
- *Eumops perotis* (Eupe)

```{r,echo=FALSE, warning=FALSE,message=FALSE}
BatOccu <- read.csv("~/new_bats/Rnew_bats/BatOccu.csv")
#print(BatOccu)
```

#Maps predicting the distribution of bats

##Yuma myotis (*Myotis yumanensis*)

```{r, echo=FALSE,message=FALSE}
library(unmarked)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49a
BatOccuMyYu<-BatOccu[,2:4]

SimOccuMyYu2<-unmarkedFrameOccu(y = BatOccuMyYu, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.My.Yu2 <- occu(~ Julian + Meanhum + Meantemp + sdhum + sdtemp ~  Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + I(Burn.intensity.Canopy^2) + Burn.intensity.basal + I(Burn.intensity.basal^2),SimOccuMyYu2)

select.My.Yu2 <- dredge(model.Occu1.My.Yu2, rank = "AICc")

best2.My.Yu2<-get.models(select.My.Yu2, 1)[[1]]
Occu1.layer.MyYu2 <- predict(best2.My.Yu2, type = "state", newdata=Predictors)

brks= c(0, 0.1, 0.2, 0.3, 0.4,0.5, 0.6,0.7, 0.8,0.9, 1)
cols <- rev(terrain.colors(10))
Occu1.layer.MyYu2<-Occu1.layer.MyYu2*PNF
plot(Occu1.layer.MyYu2$layer.1, colNA="black", main="Occupancy estimation for Yuma Myotis",breaks=brks, lab.breaks=brks, col=cols, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.My.Yu2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
yuma.stack <- stack(bs,bc, bb, Occu1.layer.MyYu2$layer.1)

names(yuma.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs (yuma.stack)
```

##California bat (*Myotis californicus*)


```{r, echo=FALSE,message=FALSE}
library(unmarked)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, results='hide'}
#N=49
BatOccuMyCa<-BatOccu[,5:7]
```

###Total model

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49

SimOccuMyCa2<-unmarkedFrameOccu(y = BatOccuMyCa, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.My.Ca2 <- occu(~ Julian +  Meanhum + Meantemp + sdhum + sdtemp ~ Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + I(Burn.intensity.Canopy^2) + Burn.intensity.basal + I(Burn.intensity.basal^2), SimOccuMyCa2)

select.My.Ca2 <- dredge(model.Occu1.My.Ca2, rank = "AICc")

best2.My.Ca2<-get.models(select.My.Ca2, 1)[[1]]
Occu1.layer.MyCa2 <- predict(best2.My.Ca2, type = "state", newdata=Predictors)

Occu1.layer.MyCa2<-Occu1.layer.MyCa2*PNF
plot(Occu1.layer.MyCa2$layer.1, colNA="black", main="Occupancy estimation for California Bat",breaks=brks, col=cols,lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.My.Ca2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
myca.stack <- stack(bs,bc, bb, Occu1.layer.MyCa2$layer.1)

names(myca.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs (myca.stack)
```

##Western Small Footed Myotis (*Myotis ciliolabrum*)

```{r, echo=FALSE,message=FALSE, results='asis'}
library(unmarked)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, results='hide'}
#N=49
BatOccuMyCi<-BatOccu[,8:10]

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49
SimOccuMyCi2<-unmarkedFrameOccu(y = BatOccuMyCi, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.My.Ci2 <- occu(~ Julian+ Meanhum + Meantemp + sdhum + sdtemp ~ Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + I(Burn.intensity.Canopy^2) + Burn.intensity.basal + I(Burn.intensity.basal^2), SimOccuMyCi2)


select.My.Ci2 <- dredge(model.Occu1.My.Ci2, rank = "AICc")

best2.My.Ci2<-get.models(select.My.Ci2, 1)[[1]]
Occu1.layer.MyCi2 <- predict(best2.My.Ci2, type = "state", newdata=Predictors)

Occu1.layer.MyCi2<-Occu1.layer.MyCi2*PNF
plot(Occu1.layer.MyCi2$layer.1, colNA="black", main="Occupancy estimation for Western Small Footed Myotis",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.My.Ci2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
myci.stack <- stack(bs,bc, bb, Occu1.layer.MyCi2$layer.1)

names(myci.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs (myci.stack)
```

##Hairy-winged bat (*Myotis volans*)

```{r, echo=FALSE,message=FALSE}
library(unmarked)
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, results='hide'}
#N=49

BatOccuMyVo<-BatOccu[,11:13]
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49
SimOccuMyVo2<-unmarkedFrameOccu(y = BatOccuMyVo, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.My.Vo2 <- occu(~ Julian + Meanhum + Meantemp ~  Burn.intensity.soil  + Burn.intensity.Canopy + Burn.intensity.basal,SimOccuMyVo2)

select.My.Vo2 <- dredge(model.Occu1.My.Vo2, rank = "AICc")
best2.My.Vo2<-get.models(select.My.Vo2, 1)[[1]]
Occu1.layer.MyVo2 <- predict(best2.My.Vo2, type = "state", newdata=Predictors)

Occu1.layer.MyVo2<-Occu1.layer.MyVo2*PNF
plot(Occu1.layer.MyVo2$layer.1, colNA="black", main="Occupancy estimation for Hairy-winged bat",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.My.Vo2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
myvo.stack <- stack(bs,bc, bb, Occu1.layer.MyVo2$layer.1)

names(myvo.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs (myvo.stack)
```

##Little Brown bat (*Myotis lucifugus*)

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, results='hide'}
#N=49
BatOccuMyLu<-BatOccu[,14:16]

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
SimOccuMyLu2<-unmarkedFrameOccu(y = BatOccuMyLu, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.My.Lu2 <- occu(~ Julian + Meanhum + Meantemp + sdhum + sdtemp ~ Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + I(Burn.intensity.Canopy^2) + Burn.intensity.basal +I(Burn.intensity.basal^2), SimOccuMyLu2)


select.My.Lu2 <- dredge(model.Occu1.My.Lu2, rank = "AICc")

best2.My.Lu2<-get.models(select.My.Lu2, 1)[[1]]
Occu1.layer.MyLu2 <- predict(best2.My.Lu2, type = "state", newdata=Predictors)

Occu1.layer.MyLu2<-Occu1.layer.MyLu2*PNF
plot(Occu1.layer.MyLu2$layer.1, colNA="black", main="Occupancy estimation for Little Brown Bat",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.My.Lu2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
mylu.stack <- stack(bs,bc, bb, Occu1.layer.MyLu2$layer.1)

names(mylu.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs (mylu.stack)
```

##Western Red Bat (*Lasiurus blossevillii*)


```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, results='hide'}
#N=49
BatOccuLaBl<-BatOccu[,20:22]
```


```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49

SimOccuLaBl2<-unmarkedFrameOccu(y = BatOccuLaBl, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.La.Bl2 <- occu(~ Julian + Meanhum + Meantemp + sdhum + sdtemp ~ Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + I(Burn.intensity.Canopy^2) + Burn.intensity.basal + I(Burn.intensity.basal^2) ,SimOccuLaBl2)

select.La.Bl2 <- dredge(model.Occu1.La.Bl2, rank = "AICc")

best2.La.Bl2<-get.models(select.La.Bl2, 1)[[1]]
Occu1.layer.LaBl2 <- predict(best2.La.Bl2, type = "state", newdata=Predictors)

Occu1.layer.LaBl2<-Occu1.layer.LaBl2*PNF
plot(Occu1.layer.LaBl2$layer.1, colNA="black", main="Occupancy estimation for Western Red Bat",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.La.Bl2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
labl.stack <- stack(bs,bc, bb, Occu1.layer.LaBl2$layer.1)

names(labl.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs (labl.stack)
```

## Long-eared Bat (*Myotis evotis*)

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, results='hide'}

#N=49

BatOccuMyEv<-BatOccu[,23:25]

```


```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49

SimOccuMyEv2<-unmarkedFrameOccu(y = BatOccuMyEv, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.My.Ev2 <- occu(~ Julian + Meanhum + Meantemp ~  Burn.intensity.soil + Burn.intensity.Canopy + Burn.intensity.basal, SimOccuMyEv2)

select.My.Ev2 <- dredge(model.Occu1.My.Ev2, rank = "AICc")

best2.My.Ev2<-get.models(select.My.Ev2, 1)[[1]]
Occu1.layer.MyEv2 <- predict(best2.My.Ev2, type = "state", newdata=Predictors)

Occu1.layer.MyEv2<-Occu1.layer.MyEv2*PNF
plot(Occu1.layer.MyEv2$layer.1, colNA="black", main="Occupancy estimation for Long Eared Bat",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.My.Ev2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
myev.stack <- stack(bs,bc, bb, Occu1.layer.MyEv2$layer.1)

names(myev.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs (myev.stack)
```


## Pallid Bat (*Antrozous pallidus*)

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, results='hide'}
#N=49
BatOccuAnPa<-BatOccu[,26:28]

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49

SimOccuAnPa2<-unmarkedFrameOccu(y = BatOccuAnPa, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.An.Pa2 <- occu(~ Julian +Meanhum + Meantemp ~ Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + I(Burn.intensity.Canopy^2) + Burn.intensity.basal + I(Burn.intensity.basal^2), SimOccuAnPa2)

select.An.Pa2 <- dredge(model.Occu1.An.Pa2, rank = "AICc")

best2.An.Pa2<-get.models(select.An.Pa2, 1)[[1]]
Occu1.layer.AnPa2 <- predict(best2.An.Pa2, type = "state", newdata=Predictors)

Occu1.layer.AnPa2<-Occu1.layer.AnPa2*PNF
plot(Occu1.layer.AnPa2$layer.1, colNA="black", main="Occupancy estimation for Pallid Bat",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.An.Pa2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
anpa.stack <- stack(bs,bc, bb, Occu1.layer.AnPa2$layer.1)

names(anpa.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs(anpa.stack)
```

###Fringed Bat (*Myotis thysanoides*)

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, results='hide'}
#N=49
BatOccuMyTh<-BatOccu[,35:37]

```


```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49
SimOccuMyTh2<-unmarkedFrameOccu(y = BatOccuMyTh, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.My.Th2 <- occu(~ Julian +Meanhum + Meantemp + sdhum + sdtemp ~  Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + I(Burn.intensity.Canopy^2) + Burn.intensity.basal +I(Burn.intensity.basal^2) ,SimOccuMyTh2)


select.My.Th2 <- dredge(model.Occu1.My.Th2, rank = "AICc")

best2.My.Th2<-get.models(select.My.Th2, 1)[[1]]
Occu1.layer.MyTh2 <- predict(best2.My.Th2, type = "state", newdata=Predictors)

Occu1.layer.MyTh2<-Occu1.layer.MyTh2*PNF
plot(Occu1.layer.MyTh2$layer.1, colNA="black", main="Occupancy estimation for Fringed Bat",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.My.Th2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
myth.stack <- stack(bs,bc, bb, Occu1.layer.MyTh2$layer.1)

names(myth.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs(myth.stack)
```

##Townsend’s Long-eared Bat (*Corynorhinus townsendii*)

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, results='hide'}
#N=49
BatOccuCoTo<-BatOccu[,44:46]
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49
SimOccuCoTo2<-unmarkedFrameOccu(y = BatOccuCoTo, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.Co.To2 <- occu(~ Julian + Meanhum + Meantemp  ~ Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + I(Burn.intensity.Canopy^2) + Burn.intensity.basal + I(Burn.intensity.basal^2), SimOccuCoTo2)


select.Co.To2 <- dredge(model.Occu1.Co.To2, rank = "AICc")

best2.Co.To2<-get.models(select.Co.To2, 1)[[1]]
Occu1.layer.CoTo2 <- predict(best2.Co.To2, type = "state", newdata=Predictors)

Occu1.layer.CoTo2<-Occu1.layer.CoTo2*PNF
plot(Occu1.layer.CoTo2$layer.1, colNA="black", main="Occupancy estimation for Townsend big eared bat",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.Co.To2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
coto.stack <- stack(bs,bc, bb, Occu1.layer.CoTo2$layer.1)

names(coto.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs(coto.stack)
```

##The western pipistrelle (*Parastrellus hesperus*)

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, results='hide'}
#N=49
BatOccuPaHe<-BatOccu[,17:19]
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49
SimOccuPaHe2<-unmarkedFrameOccu(y = BatOccuPaHe, siteCovs =sampling.cov2, obsCovs=Dailycov3)


#model.Occu1.Pa.He2 <- occu(~ Julian + Meanhum + Meantemp  ~ Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + Burn.intensity.Canopy2 + Burn.intensity.basal +Burn.intensity.basal2, SimOccuPaHe2)


#select.Pa.He2 <- dredge(model.Occu1.Pa.He2, rank = "AICc")
```

```{r, echo=FALSE, cache= TRUE, results='hide', message=FALSE,warning=FALSE}
#best2.Pa.He2<-get.models(select.Pa.He2, 1)[[1]]
#Occu1.layer.PaHe2 <- predict(best2.Pa.He2, type = "state", newdata=Predictors)
```

```{r, echo=FALSE,warning=FALSE,message=FALSE}
#Occu1.layer.PaHe2<-Occu1.layer.PaHe2*PNF
#plot(Occu1.layer.PaHe2$layer.1, colNA="black", main="Occupancy estimation for Pipistrel",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
#library(texreg)
#htmlreg(extract(subset(select.Pa.He2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
#pahe.stack <- stack(bs,bc, bb, Occu1.layer.PaHe2$layer.1)

#names(pahe.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

#pairs(pahe.stack)
```

##big brown bat (*Eptesicus fuscus*)

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, results='hide'}
#N=49
BatOccuEpFu<-BatOccu[,29:31]
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49
SimOccuEpFu2<-unmarkedFrameOccu(y = BatOccuEpFu, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.Ep.Fu2 <- occu(~ Julian + Meanhum + Meantemp + sdhum + sdtemp ~ Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + I(Burn.intensity.Canopy^2) + Burn.intensity.basal +I(Burn.intensity.basal^2), SimOccuEpFu2)


select.Ep.Fu2 <- dredge(model.Occu1.Ep.Fu2, rank = "AICc")

best2.Ep.Fu2<-get.models(select.Ep.Fu2, 1)[[1]]
Occu1.layer.EpFu2 <- predict(best2.Ep.Fu2, type = "state", newdata=Predictors)

Occu1.layer.EpFu2<-Occu1.layer.EpFu2*PNF
plot(Occu1.layer.EpFu2$layer.1, colNA="black", main="Occupancy estimation for Big Brown Bat",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.Ep.Fu2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
epfu.stack <- stack(bs,bc, bb, Occu1.layer.EpFu2$layer.1)

names(epfu.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs(epfu.stack)
```

##silver-haired bat (*Lasionycteris noctivagans*)

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, results='hide'}
#N=49
BatOccuLaNo<-BatOccu[,32:34]
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49
SimOccuLaNo2<-unmarkedFrameOccu(y = BatOccuLaNo, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.La.No2 <- occu(~ Julian + Meanhum + Meantemp + sdhum + sdtemp ~  Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + I(Burn.intensity.Canopy^2) + Burn.intensity.basal + (Burn.intensity.basal^2), SimOccuLaNo2)


select.La.No2 <- dredge(model.Occu1.La.No2, rank = "AICc")

best2.La.No2<-get.models(select.La.No2, 1)[[1]]
Occu1.layer.LaNo2 <- predict(best2.La.No2, type = "state", newdata=Predictors)

Occu1.layer.LaNo2<-Occu1.layer.LaNo2*PNF
plot(Occu1.layer.LaNo2$layer.1, colNA="black", main="Occupancy estimation for Silver Haired Bat",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.La.No2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
lano.stack <- stack(bs,bc, bb, Occu1.layer.LaNo2$layer.1)

names(lano.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs(lano.stack)
```

##Brazilian free-tailed bat (*Tadarida brasiliensis*)

```{r,echo=FALSE, warning=FALSE,message=FALSE}
BatOccuTaBr<-BatOccu[,38:40]
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49
SimOccuTaBr2<-unmarkedFrameOccu(y = BatOccuTaBr, siteCovs =sampling.cov2, obsCovs=Dailycov3)


model.Occu1.Ta.Br2 <- occu(~ Julian + Meanhum + Meantemp  ~ Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy +  I(Burn.intensity.Canopy^2) + Burn.intensity.basal + I(Burn.intensity.basal^2), SimOccuTaBr2)


select.Ta.Br2 <- dredge(model.Occu1.Ta.Br2, rank = "AICc")

best2.Ta.Br2<-get.models(select.Ta.Br2, 1)[[1]]
Occu1.layer.TaBr2 <- predict(best2.Ta.Br2, type = "state", newdata=Predictors)

Occu1.layer.TaBr2<-Occu1.layer.TaBr2*PNF
plot(Occu1.layer.TaBr2$layer.1, colNA="black", main="Occupancy estimation for Brazilian free-tailed bat",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.Ta.Br2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
tabr.stack <- stack(bs,bc, bb, Occu1.layer.TaBr2$layer.1)

names(tabr.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs(tabr.stack)
```

##hoary bat (*Lasiurus cinereus*)


```{r,echo=FALSE, warning=FALSE,message=FALSE}
BatOccuLaCi<-BatOccu[,41:43]
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49
SimOccuLaCi2<-unmarkedFrameOccu(y = BatOccuLaCi, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.La.Ci2 <- occu(~ Julian + Meanhum + Meantemp + sdhum + sdtemp ~ Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + (Burn.intensity.Canopy^2) + Burn.intensity.basal + I(Burn.intensity.basal^2), SimOccuLaCi2)


select.La.Ci2 <- dredge(model.Occu1.La.Ci2, rank = "AICc")

best2.La.Ci2<-get.models(select.La.Ci2, 1)[[1]]
Occu1.layer.LaCi2 <- predict(best2.La.Ci2, type = "state", newdata=Predictors)

Occu1.layer.LaCi2<-Occu1.layer.LaCi2*PNF
plot(Occu1.layer.LaCi2$layer.1, colNA="black", main="Occupancy estimation for Hoary Bat",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.La.Ci2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
laci.stack <- stack(bs,bc, bb, Occu1.layer.LaCi2$layer.1)

names(laci.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs(laci.stack)
```

##Spotted bat (*Euderma maculatum*)

```{r,echo=FALSE, warning=FALSE,message=FALSE}
BatOccuEuMa<-BatOccu[,47:49]
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49
SimOccuEuMa2<-unmarkedFrameOccu(y = BatOccuEuMa, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.Eu.Ma2 <- occu(~ Julian + Meanhum + Meantemp + sdhum + sdtemp ~ Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + I(Burn.intensity.Canopy^2) + Burn.intensity.basal +I(Burn.intensity.basal^2), SimOccuEuMa2)


select.Eu.Ma2 <- dredge(model.Occu1.Eu.Ma2, rank = "AICc")

best2.Eu.Ma2<-get.models(select.Eu.Ma2, 1)[[1]]
Occu1.layer.EuMa2 <- predict(best2.Eu.Ma2, type = "state", newdata=Predictors)

Occu1.layer.EuMa2<-Occu1.layer.EuMa2*PNF
plot(Occu1.layer.EuMa2$layer.1, colNA="black", main="Occupancy estimation for Spotted Bat",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.Eu.Ma2, delta <= 2, recalc.weights = FALSE)))
```

```{r,echo=FALSE,cache=TRUE}
euma.stack <- stack(bs,bc, bb, Occu1.layer.EuMa2$layer.1)

names(euma.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs(euma.stack)
```

## western mastiff bat (*Eumops perotis*)

```{r,echo=FALSE, warning=FALSE,message=FALSE}
BatOccuEuPe<-BatOccu[,50:52]
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
#N=49


sampling.cov3<-data.frame(scale(sampling.cov2))
SimOccuEuPe2<-unmarkedFrameOccu(y = BatOccuEuPe, siteCovs =sampling.cov2, obsCovs=Dailycov3)

model.Occu1.Eu.Pe2 <- occu(~ Julian + Meanhum + Meantemp + sdhum + sdtemp ~ Burn.intensity.soil + I(Burn.intensity.soil^2) + Burn.intensity.Canopy + I(Burn.intensity.Canopy^2) + Burn.intensity.basal + I(Burn.intensity.basal^2), SimOccuEuPe2)


select.Eu.Pe2 <- dredge(model.Occu1.Eu.Pe2, rank = "AICc")

best2.Eu.Pe2<-get.models(select.Eu.Pe2, 1)[[1]]
Occu1.layer.EuPe2 <- predict(best2.Eu.Pe2, type = "state", newdata=Predictors)

Occu1.layer.EuPe2<-Occu1.layer.EuPe2*PNF
plot(Occu1.layer.EuPe2$layer.1, colNA="black", main="Occupancy estimation for western mastiff bat",breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1))
```

```{r,echo=FALSE,results='asis', warning=FALSE,message=FALSE}
library(texreg)
htmlreg(extract(subset(select.Eu.Pe2, delta <= 2, recalc.weights = FALSE)))
write.csv(sampling.cov2, "yahoo.csv")
```

```{r,echo=FALSE,cache=TRUE}
eupe.stack <- stack(bs,bc, bb, Occu1.layer.EuPe2$layer.1)

names(eupe.stack)<-c("Burn intensity Soil", "Burn intensity Canopy","Burn intensity Basal", "Occupancy")

pairs(eupe.stack)
```

#Relationships between different species of Bats


```{r,echo=FALSE, cache=TRUE}
#N=49a
#AllBats<-stack(Occu1.layer.MyYu$layer.1,Occu1.layer.MyCa$layer.1,Occu1.layer.MyCi$layer.1,Occu1.layer.MyVo$layer.1,Occu1.layer.MyLu$layer.1, Occu1.layer.LaBl$layer.1, Occu1.layer.MyEv$layer.1, Occu1.layer.AnPa$layer.1, Occu1.layer.MyTh$layer.1, Occu1.layer.CoTo$layer.1)`
#names(AllBats)<-c("Yuma Myotis", "California Bat","Small Footed Myotis", "Hairy-winged bat" ,"Little Brown Bat", "Western Red Bat", "Long-eared Bat", "Pallid Bat", "Fringed Bat", "Townsend's big-eared Bat")
#plot(AllBats, breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1), colNA="black") 
#pairs(AllBats, xlim=c(0,1), ylim=c(0,1))
```

```{r,echo=FALSE, cache=TRUE}
#N=49a
#AllBats<-stack(Occu1.layer.MyYu2$layer.1, Occu1.layer.MyCa2$layer.1, Occu1.layer.MyCi2$layer.1,Occu1.layer.MyVo2$layer.1,Occu1.layer.MyLu2$layer.1, Occu1.layer.LaBl2$layer.1, Occu1.layer.MyEv2$layer.1,Occu1.layer.AnPa2$layer.1, Occu1.layer.MyTh2$layer.1, Occu1.layer.CoTo2$layer.1, Occu1.layer.EpFu2$layer.1, Occu1.layer.LaNo2$layer.1, Occu1.layer.TaBr2$layer.1, Occu1.layer.LaCi2$layer.1, Occu1.layer.EuMa2$layer.1,Occu1.layer.EuPe2$layer.1)
#names(AllBats)<-c("Yuma Myotis", "California bat","Small Footed Myotis", "Hairy-winged bat" ,"Little Brown Bat", "Western Red Bat","Long-eared Bat" ,"Pallid Bat", "Fringed Bat", "Townsend's big-eared Bat", "Big Brow Bat","Silver-Haired Bat", "Brazilian free-tailed bat", "Hoary Bat", "Spotted bat", " western mastiff bat")
#plot(AllBats, breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1), colNA="black") 
#pairs(AllBats, xlim=c(0,1), ylim=c(0,1))
```

#Fire bats


```{r,echo=FALSE, cache=TRUE}
#N=49a
FireBats<-stack(Occu1.layer.MyYu2$layer.1, Occu1.layer.MyCi2$layer.1, Occu1.layer.MyLu2$layer.1, Occu1.layer.LaBl2$layer.1, Occu1.layer.MyEv2$layer.1,Occu1.layer.AnPa2$layer.1, Occu1.layer.CoTo2$layer.1, Occu1.layer.EpFu2$layer.1, Occu1.layer.LaNo2$layer.1, Occu1.layer.TaBr2$layer.1, Occu1.layer.EuPe2$layer.1)
names(FireBats)<-c("Yuma Myotis","Small Footed Myotis","Little Brown Bat", "Western Red Bat","Long-eared Bat" ,"Pallid Bat", "Townsend's big-eared Bat", "Big Brow Bat","Silver-Haired Bat", "Brazilian free-tailed bat", " western mastiff bat")
plot(FireBats, breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1), colNA="black") 
pairs(FireBats, xlim=c(0,1), ylim=c(0,1))
```


```{r,echo=FALSE, cache=TRUE}
levelplot(FireBats, col.regions = rev(terrain.colors(99)), colorkey = list(space = "bottom"))
```


```{r, echo=FALSE, cache=TRUE}
fire <- readGDAL("~/new_bats/Rnew_bats/Bats_data_products/fire.asc")
fire<-raster (fire)

not.fire <- readGDAL("~/new_bats/Rnew_bats/Bats_data_products/not_fire.asc")
not.fire<-raster (not.fire)

fire<- reclassify(fire, cbind(0, NA))

plot(fire)
plot(not.fire)

bats.with.fire1<-FireBats*fire
bats.without.fire1<-FireBats*not.fire

names(bats.with.fire1)<-c("Yuma Myotis","Small Footed Myotis","Little Brown Bat", "Western Red Bat","Long-eared Bat" ,"Pallid Bat", "Townsend's big-eared Bat", "Big Brow Bat","Silver-Haired Bat", "Brazilian free-tailed bat", " western mastiff bat")


names(bats.without.fire1)<-c("Yuma Myotis","Small Footed Myotis","Little Brown Bat", "Western Red Bat","Long-eared Bat" ,"Pallid Bat", "Townsend's big-eared Bat", "Big Brow Bat","Silver-Haired Bat", "Brazilian free-tailed bat", " western mastiff bat")

plot(bats.with.fire1, breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1), colNA="black", main= "Fire")
plot(bats.without.fire1, breaks=brks, col=cols, lab.breaks=brks, zlim=c(0,1), colNA="black", main= "Not Fire")
```

```{r,echo=FALSE, cache=TRUE}
levelplot(bats.with.fire1, col.regions = rev(terrain.colors(99)), colorkey = list(space = "bottom"))

levelplot(bats.without.fire1, col.regions = rev(terrain.colors(99)), colorkey = list(space = "bottom"))
```

```{r, echo=FALSE, cache=TRUE}
with.fire1<-cellStats(bats.with.fire1, 'mean', na.rm=TRUE)
without.fire1<-cellStats(bats.without.fire1, 'mean', na.rm=TRUE)
with.fire.sd1<-cellStats(bats.with.fire1, 'sd', na.rm=TRUE)

with.fire1<-data.frame(with.fire1)
with.fire1<-data.frame(with.fire1)
without.fire1<-data.frame(without.fire1)

fire.response1<-cbind(with.fire1,without.fire1, with.fire.sd1)
kable(fire.response1, digits=2)
write.csv(fire.response1, file="Fire_response.csv")
```

```{r,echo=FALSE, cache=TRUE}
myyu<-as.vector(subset(bats.with.fire1,1))
myyu<-myyu[!is.na(myyu)]
t.test(myyu, alternative = "two.sided", mu = fire.response1$without.fire[1])
myyu <-(myyu-fire.response1$without.fire[1])

myci<-as.vector(subset(bats.with.fire1,2))
myci<-myci[!is.na(myci)]
t.test(myci, alternative = "two.sided", mu = fire.response1$without.fire[2])
myci <-(myci-fire.response1$without.fire[2])

mylu<-as.vector(subset(bats.with.fire1,3))
mylu<-mylu[!is.na(mylu)]
t.test(mylu, alternative = "two.sided", mu = fire.response1$without.fire[3])
mylu <-(mylu-fire.response1$without.fire[3])

labl<-as.vector(subset(bats.with.fire1,4))
labl<-labl[!is.na(labl)]
t.test(labl, alternative = "two.sided", mu = fire.response1$without.fire[4])
labl <-(labl-fire.response1$without.fire1[4])

myev<-as.vector(subset(bats.with.fire1,5))
myev<-myev[!is.na(myev)]
t.test(myev, alternative = "two.sided", mu = fire.response1$without.fire[5])
myev <-(myev-fire.response1$without.fire[5])

anpa<-as.vector(subset(bats.with.fire1,6))
anpa<-anpa[!is.na(anpa)]
t.test(anpa, alternative = "two.sided", mu = fire.response1$without.fire[6])
anpa <-(anpa-fire.response1$without.fire[6])

coto<-as.vector(subset(bats.with.fire1,7))
coto<-coto[!is.na(coto)]
t.test(coto, alternative = "two.sided", mu = fire.response1$without.fire[7])
coto <-(coto-fire.response1$without.fire[7])

epfu<-as.vector(subset(bats.with.fire1,8))
epfu<-epfu[!is.na(epfu)]
t.test(epfu, alternative = "two.sided", mu = fire.response1$without.fire[8])
epfu <-(epfu-fire.response1$without.fire[8])

lano<-as.vector(subset(bats.with.fire1,9))
lano<-lano[!is.na(lano)]
t.test(lano, alternative = "two.sided", mu = fire.response1$without.fire[9])
lano <-(lano-fire.response1$without.fire[9])

tabr<-as.vector(subset(bats.with.fire1,10))
tabr<-tabr[!is.na(tabr)]
t.test(tabr, alternative = "two.sided", mu = fire.response1$without.fire[10])
tabr <-(tabr-fire.response1$without.fire[10])


eupe<-as.vector(subset(bats.with.fire1,11))
eupe<-eupe[!is.na(eupe)]
t.test(eupe, alternative = "two.sided", mu = fire.response1$without.fire[11])
eupe <-(eupe-fire.response1$without.fire[11])

br<-cbind.data.frame(myyu,myci, mylu, labl, myev, anpa, coto, epfu, lano, tabr, eupe)
par(las = 2)
boxplot(br, outline=FALSE, cex= 0.8, ylab="Difference from unburned occupancy")
abline(h=0)

```

```{r,echo=FALSE, cache=TRUE}
myyu3<- cbind.data.frame(myyu, rep("myyu", times=(length(myyu))))
colnames(myyu3)<-c("Occu", "Species")

myci3<- cbind.data.frame(myci, rep("myci", times=(length(myci))))
colnames(myci3)<-c("Occu", "Species")

mylu3<- cbind.data.frame(mylu, rep("mylu", times=(length(mylu))))
colnames(mylu3)<-c("Occu", "Species")

labl3<- cbind.data.frame(labl, rep("labl", times=(length(labl))))
colnames(labl3)<-c("Occu", "Species")

myev3<- cbind.data.frame(myev, rep("myev", times=(length(myev))))
colnames(myev3)<-c("Occu", "Species")

anpa3<- cbind.data.frame(anpa, rep("anpa", times=(length(anpa))))
colnames(anpa3)<-c("Occu", "Species")

coto3<- cbind.data.frame(coto, rep("coto", times=(length(coto))))
colnames(coto3)<-c("Occu", "Species")

epfu3<- cbind.data.frame(epfu, rep("epfu", times=(length(epfu))))
colnames(epfu3)<-c("Occu", "Species")

lano3<- cbind.data.frame(lano, rep("lano", times=(length(lano))))
colnames(lano3)<-c("Occu", "Species")

tabr3<- cbind.data.frame(tabr, rep("tabr", times=(length(tabr))))
colnames(tabr3)<-c("Occu", "Species")

eupe3<- cbind.data.frame(eupe, rep("eupe", times=(length(eupe))))
colnames(eupe3)<-c("Occu", "Species")

br3<- rbind(myyu3, myci3, mylu3, labl3, myev3, anpa3, coto3, epfu3, lano3, tabr3, eupe3)
br3$Species<-as.factor(br3$Species)

g<-ggplot(br3, aes(x=Species, y=Occu))
g+geom_jitter(alpha=0.2, aes(color=Species), position = position_jitter(width = 0.1))+theme_bw()+geom_violin(alpha=0.7, color="gray",scale = "width")+ stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black")+ geom_hline(yintercept = 0)+theme(legend.position="none")


g+geom_violin(alpha=0.5, color="gray",scale = "width")+theme_bw()+ stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black")+ geom_hline(yintercept = 0)


g<-ggplot(br3, aes(x=Species, y=Occu))
g+geom_jitter(alpha=0.2, aes(color="grey"), position = position_jitter(width = 0.1))+theme_bw()+geom_violin(alpha=0.7, color="gray",scale = "width")+ stat_summary(fun.y=mean, geom="point", shape=18, size=3, color="black")+ geom_hline(yintercept = 0)+theme(legend.position="none")

```

```{r, cache=TRUE}
library(vioplot)
vioplot(myyu,myci, mylu, labl, myev, anpa, coto, epfu, lano, tabr, eupe, col="grey")
```


#**The End**



```{r,echo=FALSE, warning=FALSE,message=FALSE, cache=TRUE}

brickses=c(0,1.01,4)
colores=c("chartreuse4", "darkorange2")
plot((PNF+fire), legend=FALSE, breaks=brickses, col=colores)
points(RESULTS$LONG, RESULTS$LAT, cex=0.5)
map.scale(-120.7, 39.5, relwidth = 0.15, metric = TRUE, ratio = FALSE,cex=0.7)
```

```{r, echo=TRUE}
#valuetable <- getValues(AllLayers2)
#km1 <- kmeans(na.omit(valuetable), centers = 5, iter.max = 100, nstart = 10)
# create a blank raster with default values of 0
#rNA <- setValues(raster(AllLayers2), 0)
#for(i in 1:nlayers(AllLayers2)){
  #rNA[is.na(AllLayers2[[i]])] <- 1
#}
# convert rNA to an integer vector
#rNA <- getValues(rNA)
# convert valuetable to a data.frame
#valuetable <- as.data.frame(valuetable)
# if rNA is a 0, assign the cluster value at that position
#valuetable$class[rNA==0] <- km1$cluster
# if rNA is a 1, assign an NA at that position
#valuetable$class[rNA==1] <- NA
# create a blank raster
#classes1 <- raster(AllLayers2)
# assign values from the 'class' column of valuetable
#classes1 <- setValues(classes1, valuetable$class)
#plot(classes1, legend=TRUE, colNA="black")
#More info on how to do this clasification in *https://geoscripting-wur.github.io/AdvancedRasterAnalysis/*
```


#Power Analysis

```{r, echo=FALSE, cache=TRUE}
########################################################################################################
# function evaldesign
#
# this function evaluates the performance of a design for the single-season single-species occupancy model
# with constant probabilities of occupancy and detectability. the function generates simulated histories, 
# calculates the corresponding MLEs for psi and p and evaluates estimator performance
#
# e.g. myres<-evaldesign(psi=0.2,p=0.3,s=62,k=4,nits=10000,doprint=1,doplot=1) 
#
# 	function input
#		- psi: assumed value for the probability of occupancy
#		- p: assumed value for the probability of detection
#		- s: number of sites surveyed
#		- k: number of replicated surveys per site
# 		- nits: number of iterations in the simulation
#		- doprint: print results on screen
#		- doplot: plot the distribution of MLEs
# 	function output (myres$)
#		- dist: matrix containing the results of the simulation. Each row contains details for 
#                  each history type summarized by the sufficient statistics (SD,d) 
#	    	  dist[,1] contain SD (number of sites where the species was detected)
#	    	  dist[,2] contains d (total number of detections in the history)
#	    	  dist[,3] contains the probability of obtaining that history type (i.e. pair (SD,d))
#	    	  dist[,4] contains the estimate for the probability of occupancy
#	    	  dist[,5] contains the estimate for the probability of detection
#	      - biaspsi,varpsi,MSEpsi: occupancy estimator bias/variance/MSE (excl empty histories)
#	      - biasp,varp,MSEp: detectability estimator bias/variance/MSE (excl empty histories)
#		- covar: occupancy and detectability estimator covariance (excl empty histories)
#		- critA: sum of the MSEs (excl empty histories)
#		- critB: determinant of the MSE matrix (excl empty histories)
#		- biaspsi_B,varpsi_B,MSEpsi_B: occupancy estimator bias/variance/MSE (excl also boundary estimates) 
#		- ...
#    		- pempty: percentage of empty histories obtained 
#    		- pbound: percentage of histories obtained that produce boundary estimates (i.e. psi=1)
#
########################################################################################################

evaldesign <- function(psi,p,s,k,nits=10000,doprint=TRUE,doplot=TRUE) {
  
  t1=proc.time()
  
  mydist<-matrix(NA,0,5)
  jj<-1
  
  for (ii in 1:nits)   
  {
    # generate a history
    Sp<-rbinom(1,s,psi)
    hist<-rbind(matrix(rbinom(Sp*k,1,p),Sp,k),matrix(0,s-Sp,k))
    
    # summarize history (sufficient statistics)
    SD<-sum(rowSums(hist)>0)
    d<-sum(hist)
    
    # count history
    if (jj==1)
    {
      mydist<-rbind(mydist,c(SD,d,1,NA,NA))
    } else 
    {
      temp<-which((mydist[1:nrow(mydist),1]==SD))
      temp2<-which((mydist[temp,2]==d))	
      if (length(temp2)==0)
      {
        mydist<-rbind(mydist,c(SD,d,1,NA,NA))
      } else 
      { 
        #add one count to this {SD,d} history 
        mydist[temp[temp2],3]<-mydist[temp[temp2],3]+1
      }
    }	
    jj<-jj+1
  }		#end for nits
  
  
  # analyze each history type obtained in simulation
  for (ii in 1:nrow(mydist))
  {  
    SD<-mydist[ii,1]
    d<-mydist[ii,2]
    
    if (SD==0){			  #empty histories
      psihat<-NA
      phat<-NA
    } else 
    {	
      if (((s-SD)/s)<((1-d/(s*k))^k)) {	#boundary estimates
        psihat <- 1
        phat <- d/(s*k)
      } else
      {
        params = c(psi,p)   #init vals for optim
        fitted1 = optim(params,loglikf,SD=SD,d=d,s=s,k=k,lin=0)
        psihat <- 1/(1+exp(-fitted1$par[1]))      
        phat <- 1/(1+exp(-fitted1$par[2])) 
      }
    }
    
    # store estimates
    mydist[ii,4]<-psihat
    mydist[ii,5]<-phat   
    mydist[ii,3]<-mydist[ii,3]/nits
  }
  
  # MLE properties: distribution removing empty histories
  mydist2<-mydist[mydist[,1]!=0,]	
  mydist2[,3]<-mydist2[,3]/sum(mydist2[,3])
  mymeanpsi<-sum(mydist2[,3]*mydist2[,4],na.rm='true')
  mybiaspsi<-mymeanpsi-psi
  myvarpsi<-sum((mydist2[,4]-mymeanpsi)^2*mydist2[,3])
  myMSEpsi<-myvarpsi+mybiaspsi^2
  mymeanp<-sum(mydist2[,3]*mydist2[,5],na.rm='true')
  mybiasp<-mymeanp-p
  myvarp<-sum((mydist2[,5]-mymeanp)^2*mydist2[,3])
  myMSEp<-myvarp+mybiasp^2
  mycovar<-sum((mydist2[,5]-mymeanp)*(mydist2[,4]-mymeanpsi)*mydist2[,3])
  mycritA<-myMSEpsi+myMSEp
  mycritD<-myMSEpsi*myMSEp-mycovar^2
  
  # MLE properties: distribution removing also boundary estimates
  mydist3<-mydist2[mydist2[,4]!=1,]	
  mydist3[,3]<-mydist3[,3]/sum(mydist3[,3])
  mymeanpsi_B<-sum(mydist3[,3]*mydist3[,4],na.rm='true')
  mybiaspsi_B<-mymeanpsi_B-psi
  myvarpsi_B<-sum((mydist3[,4]-mymeanpsi_B)^2*mydist3[,3])
  myMSEpsi_B<-myvarpsi_B+mybiaspsi_B^2
  mymeanp_B<-sum(mydist3[,3]*mydist3[,5],na.rm='true')
  mybiasp_B<-mymeanp_B-p
  myvarp_B<-sum((mydist3[,5]-mymeanp_B)^2*mydist3[,3])
  myMSEp_B<-myvarp_B+mybiasp_B^2
  mycovar_B<-sum((mydist3[,5]-mymeanp_B)*(mydist3[,4]-mymeanpsi_B)*mydist3[,3])
  mycritA_B<-myMSEpsi_B+myMSEp_B
  mycritD_B<-myMSEpsi_B*myMSEp_B-mycovar_B^2
  
  pempty<-100*mydist[mydist[,1]==0,3]
  if (!length(pempty)) pempty=0
  pbound<-100*sum(mydist[mydist[,4]==1,3],na.rm='true')
  if (!length(pbound)) pbound=0
  
  # compute processing time
  t2=proc.time()
  
  # print in screen results
  if (doprint) {
    cat("\n--------------------------------------------------------------------------\n",sep = "")
    cat("Evaluation of design K = ",k," S = ",s, " (TS = ",s*k,")\n",sep = "")
    cat("--------------------------------------------------------------------------\n",sep = "")
    cat("estimator performance (excl empty histories)\n",sep = "")
    cat("psi: bias = ",sprintf("%+0.4f",mybiaspsi),"   var = ",sprintf("%+0.4f",myvarpsi),"   MSE = ",sprintf("%+0.4f",myMSEpsi),"\n",sep = "")
    cat("  p: bias = ",sprintf("%+0.4f",mybiasp),"   var = ",sprintf("%+0.4f",myvarp),"   MSE = ",sprintf("%+0.4f",myMSEp),"\n",sep = "")
    cat("    covar = ",sprintf("%+0.4f",mycovar)," critA = ",sprintf("%+0.4f",mycritA)," critD = ",sprintf("%+.3e",mycritD),"\n",sep = "")
    cat("estimator performance (excl also histories leading to boundary estimates)\n",sep = "")
    cat("psi: bias = ",sprintf("%+0.4f",mybiaspsi_B),"   var = ",sprintf("%+0.4f",myvarpsi_B),"   MSE = ",sprintf("%+0.4f",myMSEpsi_B),"\n",sep = "")
    cat("  p: bias = ",sprintf("%+0.4f",mybiasp_B),"   var = ",sprintf("%+0.4f",myvarp_B),"   MSE = ",sprintf("%+0.4f",myMSEp_B),"\n",sep = "")
    cat("    covar = ",sprintf("%+0.4f",mycovar_B)," critA = ",sprintf("%+0.4f",mycritA_B)," critD = ",sprintf("%+.3e",mycritD_B),"\n",sep = "")
    cat(" empty histories = ",sprintf("%0.1f",pempty),"%\n",sep = "")
    cat(" boundary estimates = ",sprintf("%0.1f",pbound),"%\n",sep = "")
    cat("this took ", (t2-t1)[1],"seconds \n")
    cat("--------------------------------------------------------------------------\n\n",sep = "")
  }
  
  # write results 
  myres <- list(dist=mydist,biaspsi=mybiaspsi,varpsi=myvarpsi,MSEpsi=myMSEpsi,biasp=mybiasp,varp=myvarp,
                MSEp=myMSEp,covar=mycovar,critA=mycritA,critD=mycritD,biaspsi_B=mybiaspsi_B,varpsi_B=myvarpsi_B,
                MSEpsi_B=myMSEpsi_B,biasp_B=mybiasp_B,varp_B=myvarp_B,MSEp_B=myMSEp_B,covar_B=mycovar_B,
                critA_B=mycritA_B,critD_B=mycritD_B,pempty=pempty,pbound=pbound)
  
  if (doplot) plotMLEdist(myres$dist,p,psi)
  
  return(myres)
  
}
########################################################################################################



########################################################################################################
# function loglikf 
#
# this function computes the likelihood function for the single-season single-species occupancy model
# with constant probabilities of occupancy and detectability, given a history summarized by (SD,d) 
#
# 	function input
#		- params: values of psi and p where the likelihood is evaluated
#		- SD: number of sites where the species was detected
#		- d: total number of detections in the history
#		- s: number of sites surveyed
#		- k: number of replicated surveys per site
# 		- lin: indicates whether the values of psi and p are given in linear of logit domain
# 	function output
#		- loglik: value of the likelihood function
#
########################################################################################################

loglikf <- function(params, SD, d, s, k, lin) {
  
  if (lin){
    psi         = params[1]   
    p           = params[2]  
  } else {
    psi         = 1/(1+exp(-params[1]))  
    p           = 1/(1+exp(-params[2]))
  }
  
  loglik = -(SD*log(psi)+d*log(p)+(k*SD-d)*log(1-p)+(s-SD)*log((1-psi)+psi*(1-p)^k))
}

########################################################################################################



########################################################################################################
# function plotMLEdist 
#
# this function displays the distribution of the MLEs obtained for the given design and values of 
# occupancy and detectability (single-season single-species occupancy model with constant probabilities)
#
########################################################################################################

plotMLEdist <- function(mydist, p, psi)
{        
  mcol<-rev(rainbow(200))
  mcol<-c(mcol[52:200],mcol[1:16])
  range=cbind(1,length(mcol))	
  x <-mydist[,3]
  y <-as.integer((range[2]-range[1])*(x-min(x))/(max(x)-min(x)))+1
  plot(mydist[,5],mydist[,4],col=mcol[y],xlim=cbind(0,1),ylim=cbind(0,1),xlab=expression(hat("p")),
       ylab=expression(hat("psi")),pch=19)
  abline(v=p, col="lightgray")
  abline(h=psi, col="lightgray")
}
########################################################################################################
```

```{r, echo=FALSE, cache=TRUE}
best2.My.Vo2
confint(best2.My.Vo2, type='det', method = 'normal')
confint(best2.My.Vo2, type='det', method = 'profile')
lc <- linearComb(best2.My.Vo2['det'],c(1,0.5))
btlc <- backTransform(lc)
btlc
summary(btlc)

confint(btlc, level = 0.9)
re <- ranef(best2.My.Vo2)
sum(bup(re, stat="mode"))


myres<-evaldesign(psi=0.377,p=0.3,s=49,k=3,nits=10000,doprint=1,doplot=1) 
myres
```

```{r}
Predictors
summary(sampling.cov2)
```

```{r, cache=TRUE}

Occu1.layer.MyLu2$layer.1

plot(Predictors)
names(Predictors)

soil.fire.vector<-as.vector(subset(Predictors,11))
canopy.fire.vector<-as.vector(subset(Predictors,13))
basal.fire.vector<-as.vector(subset(Predictors,15))

 
occu.vector<-as.vector(Occu1.layer.MyLu2$layer.1)

fire.response.df <- data.frame(cbind(soil.fire.vector, basal.fire.vector, canopy.fire.vector, occu.vector))

summary(fire.response.df)

plot(occu.vector~soil.fire.vector)

plot(occu.vector~basal.fire.vector)

plot(occu.vector~canopy.fire.vector)

ggplot(fire.response.df, aes(canopy.fire.vector, occu.vector))+geom_point()+ggtitle('Occupancy of Little Brown Bat')+labs(x="Canopy burn intensity", y="Occupancy")+theme_bw()+geom_smooth()
```